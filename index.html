<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Diaper Tracker</title>
<style>
*{box-sizing:border-box}html,body{margin:0;padding:0}
:root{
  --ink:#27314a;--muted:#6e7a96;--card:#fff;--brand:#6a8dff;--line:#e9e6ff;
  --green:#1a7f37;--red:#d32f2f;--pink:#ff9fc7;--soft:#fff7fb
}
body{font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#fffaff,#f7fbff);color:var(--ink)}
.container{max-width:1320px;margin:8px auto;padding:12px;display:grid;grid-template-columns:360px 1fr;gap:16px}
.panel,.calendar-card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px}
.btn{border:none;border-radius:12px;padding:10px 14px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 2px 0 rgba(0,0,0,.05)}
.btn.ghost{background:transparent;border:1px solid var(--line);color:#1a2442}
.grid{display:grid;gap:8px}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
h1{
  margin:10px 0 0;text-align:center;
  font-family:'Comic Sans MS','Baloo 2','Quicksand',cursive;
  font-weight:800;letter-spacing:.5px;color:#ff86bd;
  text-shadow:0 1px 0 #ffe3ef, 0 3px 8px rgba(255,134,189,.25);
  font-size:28px;
}
.subtitle{text-align:center;color:var(--muted);margin-bottom:8px}
/* Onglets images */
.tabs{display:flex;gap:10px;margin:6px 0;justify-content:space-between}
.tabs img.tab{width:72px;height:72px;padding:4px;border-radius:14px;border:2px solid var(--line);background:#fff;cursor:pointer;transition:.2s}
.tabs img.tab.active{border-color:#ffc7de;box-shadow:0 0 0 4px #fff, 0 0 0 6px #ffe6f2}
.tab-content{display:none}.tab-content.show{display:block}
/* Calendrier */
.cal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.month-label{font-weight:800}
.cal-grid{display:grid;grid-template-columns:repeat(7,minmax(80px,1fr));gap:3px}
.day-head{color:var(--muted);text-align:center;font-weight:700;font-size:12px}
.day{min-height:100px;border:1px solid var(--line);border-radius:10px;padding:4px;display:grid;grid-template-rows:auto 1fr auto;gap:2px;cursor:pointer;background:#fff}
.day .num{font-weight:800;font-size:12px}
.day .thumb{display:flex;align-items:center;justify-content:center}
.day .thumb img{width:64px;height:64px;object-fit:contain}
.day .pts{justify-self:end;font-weight:700;font-size:11px}
/* L√©gende & compteurs */
.legend-panel{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:6px}
.legend-panel .it{display:flex;align-items:center;gap:6px;border:1px dashed var(--line);border-radius:999px;padding:4px 8px}
.legend-panel img{width:28px;height:28px;object-fit:contain}
.progress{display:grid;gap:8px;margin-bottom:8px}
.progress-row{display:grid;grid-template-columns:84px 1fr max-content;gap:8px;align-items:center}
.progress-row .bar{height:10px;background:#f5f6ff;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.progress-row .bar>div{height:100%;width:0;background:linear-gradient(90deg,#ffdbec,#ff86bd);transition:width .3s}
.stat-line{display:flex;justify-content:space-between;margin-top:4px}
.small{color:#6e7a96;font-size:12px}
.pos{color:#1a7f37;font-weight:700}.neg{color:#d32f2f;font-weight:700}
.goal{font-size:12px;font-weight:700}
/* Modales & vue jour */
.modal{position:fixed;inset:0;display:none}.modal.show{display:block}
.modal-backdrop{position:absolute;inset:0;background:rgba(29,35,58,.45)}
.modal-body{position:relative;background:#fff;border-radius:16px;padding:12px;border:1px solid var(--line);width:min(960px,calc(100% - 24px));margin:40px auto;max-height:90vh;overflow:auto}
.section{margin-top:8px}.section.compact{margin-top:4px}
.checklist{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.check-item{border:1px dashed var(--line);border-radius:12px;padding:10px;display:flex;align-items:center;gap:14px}
.check-item img{width:110px;height:110px;object-fit:contain}
.state-row{display:flex;justify-content:center;align-items:center;gap:20px}
.state-controls{display:grid;gap:8px;align-content:center;justify-items:start}
#stateImg{display:block;margin:0 auto}
.pills .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;cursor:pointer}
.pill.active{background:#edf2ff;border-color:#c7d2fe}
.badge{display:inline-block;background:#edf2ff;color:#334;padding:4px 8px;border-radius:999px;font-size:12px}
.textarea{width:100%;min-height:140px;border:1px solid var(--line);border-radius:12px;padding:12px;resize:vertical;background:#fff;box-shadow:inset 0 1px 0 #f7f2ff}
.rule{border:1px dashed var(--line);border-radius:10px;padding:8px;display:flex;justify-content:space-between;align-items:center}
hr{border:none;border-top:1px dashed var(--line);margin:10px 0}
.task-row{display:flex;justify-content:space-between;align-items:center;border:1px dashed var(--line);border-radius:10px;padding:8px}
.task-row .left{display:flex;align-items:center;gap:8px}
/* Formulaire "Cr√©er une action" am√©lior√© */
.form-card{background:var(--soft);border:1px dashed #ffd6ea;border-radius:16px;padding:12px}
.input{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;outline:none}
.input:focus{box-shadow:0 0 0 3px #ffe6f2;border-color:#ffc7de}
.file-wrap{position:relative;display:inline-flex;align-items:center;gap:8px}
.file-wrap input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer}
.file-btn{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 12px;font-weight:700}
/* Objectifs : police enfantine plus grande */
.objkid{font-family:'Comic Sans MS','Baloo 2','Quicksand',cursive;font-size:16.5px;line-height:1.5}
.badge-row{display:flex;gap:8px;flex-wrap:wrap}
.badge-pill{background:#ffe6f2;border:1px solid #ffc7de;border-radius:999px;padding:4px 8px;font-size:12px}
.card{border:1px solid var(--line);border-radius:12px;padding:10px}
.item-row{display:flex;align-items:center;justify-content:space-between;border:1px dashed var(--line);border-radius:10px;padding:8px;margin-top:6px}
.item-row .left{display:flex;align-items:center;gap:8px}
.item-row input, .item-row select{border:1px solid var(--line);border-radius:8px;padding:6px 8px}
</style>
</head>
<body>
<h1>Diaper Tracker</h1>
<div class="subtitle">suivie pour apprendre √† devenir un vrai b√©b√©</div>

<main class="container">
  <aside class="panel">
    <!-- Onglets -->
    <div class="tabs">
      <img class="tab active" data-tab="actions" src="images/action.webp" alt="Actions">
      <img class="tab" data-tab="objectifs" src="images/objectif.webp" alt="Objectifs">
      <img class="tab" data-tab="rules" src="images/regles-bebe.webp" alt="R√®gles de b√©b√©">
      <img class="tab" data-tab="points" src="images/points.webp" alt="Modifier points">
    </div>

    <div id="tab-actions" class="tab-content show">
      <h3>Compteurs</h3>
      <div class="progress">
        <div class="progress-row">
          <div>Semaine</div><div class="bar"><div id="weeklyBar"></div></div><div><b id="weeklyPts">0</b> pts<br><span id="weeklyGoal" class="goal"></span></div>
        </div>
        <div class="progress-row">
          <div>Mois</div><div class="bar"><div id="monthlyBar"></div></div><div><b id="monthlyPts">0</b> pts<br><span id="monthlyGoal" class="goal"></span></div>
        </div>
        <div class="progress-row">
          <div>Couches</div><div class="bar"><div id="diapersBar"></div></div><div><b id="monthDiapers">0</b> utilis√©es</div>
        </div>
      </div>
      <hr/>

      <h3>Cr√©er une action</h3>
      <form id="addTaskForm" class="grid form-card" style="margin-top:6px">
        <input id="taskName" class="input" placeholder="Nom de l'action (ex: Lecture)" required>
        <input id="taskPoints" class="input" type="number" placeholder="Points (+/-)" required>
        <div class="flex" style="justify-content:space-between">
          <label class="file-wrap">
            <span class="file-btn">üìé Choisir une image</span>
            <input id="taskSticker" type="file" accept="image/*">
          </label>
          <button class="btn">Ajouter</button>
        </div>
      </form>

      <!-- L√©gende √©tat -->
      <div class="legend-panel">
        <div class="it"><img id="imgClean" alt=""><span>propre</span><span class="small">(0 pt)</span></div>
        <div class="it"><img id="imgWet" alt=""><span>pipi</span><span class="small">= <b id="wetPts">2</b> pts</span></div>
        <div class="it"><img id="imgMessy" alt=""><span>sale</span><span class="small">+ <b id="salePts">5</b> pts</span></div>
        <div class="it"><img id="imgSlip" alt=""><span>slip (0 couche)</span><span class="small"><b id="zeroPts">-5</b> pts</span></div>
      </div>

      <h3 style="margin-top:8px">Actions existantes</h3>
      <div id="taskList" class="grid"></div>
    </div>

    <div id="tab-objectifs" class="tab-content">
      <h3>Badges √† d√©bloquer</h3>
      <ul class="small objkid" id="goalsList"></ul>

      <div class="grid" style="margin-top:10px">
        <div class="card">
          <h4>üéÅ R√©compenses</h4>
          <div class="badge-row small"><span class="badge-pill">Semaine</span><span class="badge-pill">Mois</span></div>
          <form id="addReward" class="flex" style="margin-top:8px">
            <input id="rewardLabel" class="input" placeholder="Ex: Sortie au parc" required style="flex:1">
            <select id="rewardScope">
              <option value="weekly">Semaine</option>
              <option value="monthly">Mois</option>
            </select>
            <input id="rewardThreshold" class="input" type="number" placeholder="Seuil (pts)" required style="width:120px">
            <button class="btn">Ajouter</button>
          </form>
          <div id="rewardsList"></div>
        </div>

        <div class="card">
          <h4>‚ö†Ô∏è Punitions</h4>
          <div class="badge-row small"><span class="badge-pill">Semaine</span><span class="badge-pill">Mois</span></div>
          <form id="addPunish" class="flex" style="margin-top:8px">
            <input id="punishLabel" class="input" placeholder="Ex: Couche t√¥t" required style="flex:1">
            <select id="punishScope">
              <option value="weekly">Semaine</option>
              <option value="monthly">Mois</option>
            </select>
            <input id="punishThreshold" class="input" type="number" placeholder="Seuil (pts)" required style="width:120px">
            <button class="btn">Ajouter</button>
          </form>
          <div id="punishList"></div>
        </div>
      </div>
    </div>

    <div id="tab-rules" class="tab-content">
      <h3>R√®gles de b√©b√©</h3>
      <div class="grid">
        <textarea id="ruleInput" class="textarea" placeholder="√âcris/colle ici ta r√®gle. Cliquer sur 'Enregistrer' l'ajoutera √† la fin de la liste."></textarea>
        <div class="flex">
          <button class="btn" id="addRuleBtn">Enregistrer</button>
          <button class="btn ghost" id="showRules">R√®gles</button>
          <button class="btn ghost" id="clearRules">Tout effacer</button>
        </div>
      </div>
    </div>

    <div id="tab-points" class="tab-content">
      <h3>Modifier les points & objectifs</h3>
      <div class="grid small">
        <div class="task-row"><div class="left"><img id="sw" style="width:24px;height:24px"><span>Pipi</span></div><input id="wetPtsInput" class="input" type="number" value="2" style="width:110px"></div>
        <div class="task-row"><div class="left"><img id="sm" style="width:24px;height:24px"><span>Sale</span></div><input id="salePtsInput" class="input" type="number" value="5" style="width:110px"></div>
        <div class="task-row"><div class="left"><img id="ss" style="width:24px;height:24px"><span>0 couche (slip)</span></div><input id="zeroPtsInput" class="input" type="number" value="-5" style="width:110px"></div>
        <div class="task-row"><div class="left">üç∑ P√©nalit√© par verre d'alcool</div><input id="drinkPenaltyInput" class="input" type="number" value="-1" style="width:110px"></div>
        <hr>
        <div class="task-row"><div class="left">üéØ Seuils <b>Semaine</b> (3 paliers)</div>
          <div class="flex"><input id="w1" class="input" type="number" style="width:90px"><input id="w2" class="input" type="number" style="width:90px"><input id="w3" class="input" type="number" style="width:90px"></div>
        </div>
        <div class="task-row"><div class="left">üèÜ Seuils <b>Mois</b> (3 paliers)</div>
          <div class="flex"><input id="m1" class="input" type="number" style="width:90px"><input id="m2" class="input" type="number" style="width:90px"><input id="m3" class="input" type="number" style="width:90px"></div>
        </div>
        <hr>
        <div id="pointsTaskList" class="grid"></div>
        <button class="btn" id="savePoints">Enregistrer</button>
      </div>
    </div>

  </aside>

  <section class="calendar-card">
    <div class="cal-head">
      <button class="btn ghost" id="prevMonth">‚Üê</button>
      <div class="month-label" id="monthLabel"></div>
      <button class="btn ghost" id="nextMonth">‚Üí</button>
    </div>
    <div class="cal-grid" id="calGrid"></div>
  </section>
</main>

<!-- MODALE JOUR -->
<div class="modal" id="dayModal">
  <div class="modal-backdrop" id="mb"></div>
  <div class="modal-body">
    <div class="flex" style="justify-content:space-between">
      <h3 id="mdDate">‚Äî</h3>
      <button class="btn ghost" id="closeM">Fermer</button>
    </div>
    <div class="section compact">
      <h4>√âtat de la couche</h4>
      <div class="state-row">
        <img id="stateImg" src="" width="230" height="230" style="object-fit:contain">
        <div class="state-controls">
          <button class="btn ghost" data-set="0">Propre</button>
          <button class="btn ghost" data-set="1">Pipi</button>
          <button class="btn ghost" data-set="2">Sale</button>
        </div>
      </div>
    </div>
    <div class="section compact">
      <h4>Actions du jour</h4>
      <div id="checklist" class="checklist"></div>
    </div>
    <div class="section compact">
      <h4>Couches utilis√©es (statistique)</h4>
      <div class="pills flex">
        <span class="pill" data-n="0">0</span>
        <span class="pill" data-n="1">1</span>
        <span class="pill" data-n="2">2</span>
        <span class="pill" data-n="3">3</span>
        <span class="pill" data-n="4">4</span>
      </div>
      <div class="small">S√©lectionner <b>0</b> affichera le <b>slip</b> pour la journ√©e et appliquera la p√©nalit√© d'alcool si renseign√©e.</div>
    </div>
    <div class="section compact">
      <h4>Alcool</h4>
      <div class="flex"><label>Nombre de verres bus :</label><input id="drinksInput" class="input" type="number" min="0" step="1" style="width:120px" value="0"></div>
      <div class="small">Chaque verre enl√®ve <b id="drinkPenaltyInfo">1</b> point (param√©trable dans "Modifier points").</div>
    </div>
    <div class="section compact">
      <div class="stat-line"><span>Points du jour</span><b id="dayPts">0</b></div>
    </div>
  </div>
</div>

<!-- MODALE REGLES LISTE -->
<div class="modal" id="rulesModal">
  <div class="modal-backdrop" id="rb"></div>
  <div class="modal-body">
    <div class="flex" style="justify-content:space-between">
      <h3>R√®gles de b√©b√©</h3>
      <button class="btn ghost" id="closeR">Fermer</button>
    </div>
    <div id="rulesList" class="grid" style="margin-top:8px"></div>
  </div>
</div>

<!-- Firebase SDK v10 (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

<script>
/*** 1) Configuration Firebase (tes valeurs) ***/
const firebaseConfig = {
  apiKey: "AIzaSyAmSVQKKqm9X9yUvy7XQsg5Jt2K2rXL-wM",
  authDomain: "dl-track.firebaseapp.com",
  projectId: "dl-track",
  storageBucket: "dl-track.appspot.com",
  messagingSenderId: "126725220245",
  appId: "1:126725220245:web:4bc43252a9c91deadf789c",
  measurementId: "G-9M4P6Q8SYD"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Espace via ?space=... (ex: ?space=famille)
const spaceId=(new URLSearchParams(location.search).get('space')||'default').toLowerCase().replace(/[^a-z0-9-_]+/g,'');
const clientId=Math.random().toString(36).slice(2);
const docRef=db.collection('spaces').doc(spaceId);

/*** 2) Donn√©es locales (cache + fallback) ***/
const KEYS={
  entries:'dt_v9_entries',tasks:'dt_v9_tasks',rules:'dt_v9_rules',images:'dt_v9_images',
  thresholds:'dt_v9_thresholds',rewards:'dt_v9_rewards',punishments:'dt_v9_punishments',rulesArr:'dt_v9_rules_arr'
};

let rules=JSON.parse(localStorage.getItem(KEYS.rules)||'null')||{wet:2,sale:5,zero:-5,drink:-1};
let thresholds=JSON.parse(localStorage.getItem(KEYS.thresholds)||'null')||{weekly:[30,50,80],monthly:[100,200,300]};
let rewards=JSON.parse(localStorage.getItem(KEYS.rewards)||'null')||[];       // {label, scope:'weekly'|'monthly', threshold}
let punishments=JSON.parse(localStorage.getItem(KEYS.punishments)||'null')||[]; // idem
let rulesArr=JSON.parse(localStorage.getItem(KEYS.rulesArr)||'null')||[];      // tableau de r√®gles (texte)

let tasks=JSON.parse(localStorage.getItem(KEYS.tasks)||'null')||[
 {id:'no_alcohol',name:'No alcohol',points:1,icon:'images/no_alcohol.webp'},
 {id:'exercise',name:'Sport',points:2,icon:'images/sport.webp'},
 {id:'eat_healthy',name:'Manger sainement',points:2,icon:'images/healthy.webp'},
 {id:'house_task',name:'M√©nage',points:1,icon:'images/cleaning.webp'},
 {id:'public_diaper',name:'Couche en public',points:2,icon:'images/diaper_public.webp'},
 {id:'friends_diaper',name:'couche avec des amis',points:5,icon:'images/diaper_friend.webp'},
 {id:'diaper_family',name:'Porter des couches en famille',points:20,icon:'images/diaper_family.webp'}
];
let images=JSON.parse(localStorage.getItem(KEYS.images)||'null')||{
 state_clean:'images/diaper_clean.webp',
 state_wet:'images/diaper_wet.webp',
 state_messy:'images/diaper_messy.webp',
 slip:'images/slip.webp',
 body:'images/body.webp'
};
let entries=JSON.parse(localStorage.getItem(KEYS.entries)||'{}');

function saveLocal(){
  localStorage.setItem(KEYS.tasks,JSON.stringify(tasks));
  localStorage.setItem(KEYS.images,JSON.stringify(images));
  localStorage.setItem(KEYS.entries,JSON.stringify(entries));
  localStorage.setItem(KEYS.rules,JSON.stringify(rules));
  localStorage.setItem(KEYS.thresholds,JSON.stringify(thresholds));
  localStorage.setItem(KEYS.rewards,JSON.stringify(rewards));
  localStorage.setItem(KEYS.punishments,JSON.stringify(punishments));
  localStorage.setItem(KEYS.rulesArr,JSON.stringify(rulesArr));
}
let saving=false;
function saveCloud(){
  if(saving) return;
  saving=true;
  docRef.set({tasks,images,entries,rules,thresholds,rewards,punishments,rulesArr,_clientId:clientId,updatedAt:Date.now()},{merge:true})
    .finally(()=>saving=false);
}
docRef.onSnapshot(snap=>{
  const data=snap.data(); if(!data||data._clientId===clientId) return;
  if(data.tasks) tasks=data.tasks;
  if(data.images) images=data.images;
  if(data.entries) entries=data.entries;
  if(data.rules) rules=data.rules;
  if(data.thresholds) thresholds=data.thresholds;
  if(Array.isArray(data.rewards)) rewards=data.rewards;
  if(Array.isArray(data.punishments)) punishments=data.punishments;
  if(Array.isArray(data.rulesArr)) rulesArr=data.rulesArr;
  saveLocal(); renderAll();
});

/*** 3) Logique ***/
function ensureDay(k){ if(!entries[k]) entries[k]={diaperState:0,checks:{},diapersUsed:1,drinks:0}; }
function fmt(d){return d.toISOString().slice(0,10);}

function dayPoints(key){
  ensureDay(key);
  const d=entries[key];
  const st=Number(d.diaperState)||0;
  const isZero=Number(d.diapersUsed)===0;
  const wetPts=Number.isFinite(Number(rules.wet))?Number(rules.wet):0;
  const salePts=Number.isFinite(Number(rules.sale))?Number(rules.sale):0;
  const zeroPenalty=isZero?(Number.isFinite(Number(rules.zero))?Number(rules.zero):-5):0;
  const drinkPen=Number.isFinite(Number(rules.drink))?Number(rules.drink):-1;
  const drinks=Number(d.drinks)||0;

  const diaperPts=isZero?0:((st>=1?wetPts:0)+(st===2?salePts:0));
  const checksPts=Object.entries(d.checks||{}).reduce((s,[id,v])=>{
    if(!v) return s; const t=tasks.find(t=>t.id===id); const p=Number(t&&t.points);
    return s+(Number.isFinite(p)?p:0);
  },0);

  return diaperPts + checksPts + zeroPenalty + (drinks*drinkPen);
}
function dayPointsSafe(k){ return entries[k]?dayPoints(k):0; }

/*** 4) Rendu ***/
const calGrid=document.getElementById('calGrid'); const monthLabel=document.getElementById('monthLabel');

function renderGoalsList(){
  const ul=document.getElementById('goalsList');
  const [w1,w2,w3]=thresholds.weekly, [m1,m2,m3]=thresholds.monthly;
  ul.innerHTML=`
    <li><b>Semaine</b>: ${w1} ‚Üí Jeune enfant ¬∑ ${w2} ‚Üí Apprentie b√©b√© ¬∑ ${w3} ‚Üí B√©b√© √† sa maman</li>
    <li><b>Mois</b>: ${m1} ‚Üí Quitte le monde des adultes ¬∑ ${m2} ‚Üí devient un b√©b√© ¬∑ ${m3} ‚Üí Vrai b√©b√©</li>
  `;
}
function goalLabel(val, arr, labels){
  if(val>=arr[2]) return labels[2];
  if(val>=arr[1]) return labels[1];
  if(val>=arr[0]) return labels[0];
  return '';
}

function firstWeekday(y,m){return (new Date(y,m,1).getDay()+6)%7;}
function daysInMonth(y,m){return new Date(y,m+1,0).getDate();}
function renderCalendar(){
  calGrid.innerHTML='';
  const days=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim']; days.forEach(n=>{const h=document.createElement('div');h.className='day-head';h.textContent=n;calGrid.appendChild(h);});
  const y=(viewing||new Date()).getFullYear(), m=(viewing||new Date()).getMonth();
  monthLabel.textContent=new Date(y,m,1).toLocaleDateString('fr-FR',{month:'long',year:'numeric'});

  for(let i=0;i<firstWeekday(y,m);i++){const b=document.createElement('div');b.className='day';b.style.visibility='hidden';calGrid.appendChild(b);}
  const total=daysInMonth(y,m);
  for(let d=1; d<=total; d++){
    const key=fmt(new Date(y,m,d,12));
    const st=(entries[key]&&entries[key].diaperState)||0;
    let img=null;
    if(!entries[key]) img=images.body;
    else if(Number(entries[key].diapersUsed)===0) img=images.slip;
    else img=(st===2?images.state_messy: st===1?images.state_wet: images.state_clean);
    const cell=document.createElement('div'); cell.className='day';
    cell.innerHTML=`<div class="num">${d}</div><div class="thumb">${img?`<img src="${img}" alt="">`:''}</div><div class="pts">${dayPointsSafe(key)} pts</div>`;
    cell.onclick=()=>openDay(key);
    calGrid.appendChild(cell);
  }

  // Totaux
  function weekStart(d){const x=new Date(d);x.setHours(0,0,0,0);const k=(x.getDay()+6)%7;x.setDate(x.getDate()-k);return x;}
  const now=new Date(); const s=weekStart(now);
  let w=0; for(let i=0;i<7;i++){const d=new Date(s);d.setDate(s.getDate()+i); w+=dayPointsSafe(fmt(d));}
  let mo=0; for(let d=1; d<=total; d++){ const k=fmt(new Date(y,m,d,12)); mo+=dayPointsSafe(k); }
  // Couches (mois)
  let used=0; for(let d=1; d<=total; d++){ const k=fmt(new Date(y,m,d,12)); if(entries[k]?.diapersUsed!=null) used+=Number(entries[k].diapersUsed)||0; }
  const maxDiapers=Math.max(1,total*4);

  document.getElementById('weeklyPts').textContent=w; 
  document.getElementById('monthlyPts').textContent=mo;
  document.getElementById('weeklyBar').style.width=Math.min(100,Math.round(100*w/100))+'%';
  document.getElementById('monthlyBar').style.width=Math.min(100,Math.round(100*mo/400))+'%';
  document.getElementById('monthDiapers').textContent=used;
  document.getElementById('diapersBar').style.width=Math.min(100, Math.round(100*used/maxDiapers)) + '%';

  document.getElementById('weeklyGoal').textContent=goalLabel(w, thresholds.weekly, ['Jeune enfant','Apprentie b√©b√©','B√©b√© √† sa maman']);
  document.getElementById('monthlyGoal').textContent=goalLabel(mo, thresholds.monthly, ['Quitte le monde des adultes','devient un b√©b√©','Vrai b√©b√©']);
}
let viewing=new Date(); viewing.setDate(1);
document.getElementById('prevMonth').onclick=()=>{viewing.setMonth(viewing.getMonth()-1);renderCalendar();};
document.getElementById('nextMonth').onclick=()=>{viewing.setMonth(viewing.getMonth()+1);renderCalendar();};

/*** 5) Actions ***/
const taskList=document.getElementById('taskList');
function renderTaskList(){
  taskList.innerHTML='';
  tasks.forEach((t,i)=>{
    const row=document.createElement('div'); row.className='task-row';
    row.innerHTML=`<div class="left"><img src="${t.icon}" style="width:28px;height:28px;object-fit:contain"><span>${t.name}</span><span class="${t.points>=0?'pos':'neg'} small">(${t.points} pts)</span></div><button class="btn ghost" data-del="${i}">Supprimer</button>`;
    row.querySelector('[data-del]').onclick=()=>{tasks.splice(i,1); saveLocal(); saveCloud(); renderTaskList(); renderPointsEditor();};
    taskList.appendChild(row);
  });
}
document.getElementById('addTaskForm').onsubmit=(e)=>{
  e.preventDefault();
  const name=document.getElementById('taskName').value.trim();
  const pts=Number(document.getElementById('taskPoints').value);
  const file=document.getElementById('taskSticker').files[0];
  if(!name || !Number.isFinite(pts)) return;
  function add(icon){
    tasks.push({id:name.toLowerCase().replace(/[^a-z0-9]+/g,'_'),name,points:pts,icon:icon||'images/diaper_clean.webp'});
    saveLocal(); saveCloud(); renderTaskList(); renderPointsEditor(); e.target.reset();
  }
  if(file){const r=new FileReader(); r.onload=ev=>add(ev.target.result); r.readAsDataURL(file);} else add('images/diaper_clean.webp');
};

/*** 6) Points & Seuils ***/
function renderPointsEditor(){
  const host=document.getElementById('pointsTaskList'); host.innerHTML='';
  tasks.forEach((t,i)=>{
    const row=document.createElement('div'); row.className='task-row';
    row.innerHTML=`<div class="left"><img src="${t.icon}" style="width:24px;height:24px"><span>${t.name}</span></div><input type="number" class="input" value="${t.points}" data-pts="${i}" style="width:110px">`;
    row.querySelector('input').onchange=(e)=>{tasks[i].points=Number(e.target.value)||0; saveLocal(); };
    host.appendChild(row);
  });
  // seuils
  [document.getElementById('w1').value,document.getElementById('w2').value,document.getElementById('w3').value]=thresholds.weekly;
  [document.getElementById('m1').value,document.getElementById('m2').value,document.getElementById('m3').value]=thresholds.monthly;
  document.getElementById('wetPtsInput').value=rules.wet;
  document.getElementById('salePtsInput').value=rules.sale;
  document.getElementById('zeroPtsInput').value=rules.zero;
  document.getElementById('drinkPenaltyInput').value=rules.drink;
  document.getElementById('drinkPenaltyInfo').textContent=Math.abs(Number(rules.drink)||1);
}
document.getElementById('savePoints').onclick=()=>{
  rules.wet=Number(document.getElementById('wetPtsInput').value)||0;
  rules.sale=Number(document.getElementById('salePtsInput').value)||0;
  rules.zero=Number(document.getElementById('zeroPtsInput').value); if(!Number.isFinite(rules.zero)) rules.zero=-5;
  rules.drink=Number(document.getElementById('drinkPenaltyInput').value); if(!Number.isFinite(rules.drink)) rules.drink=-1;

  thresholds.weekly=[Number(document.getElementById('w1').value)||0, Number(document.getElementById('w2').value)||0, Number(document.getElementById('w3').value)||0];
  thresholds.monthly=[Number(document.getElementById('m1').value)||0, Number(document.getElementById('m2').value)||0, Number(document.getElementById('m3').value)||0];

  saveLocal(); saveCloud(); renderTaskList(); renderCalendar(); renderPointsEditor(); renderGoalsList();
  document.getElementById('wetPts').textContent=rules.wet;
  document.getElementById('salePts').textContent=rules.sale;
  document.getElementById('zeroPts').textContent=rules.zero;
};

/*** 7) R√®gles (liste + modale) ***/
function renderRulesModal(){
  const host=document.getElementById('rulesList'); host.innerHTML='';
  if(!rulesArr.length){ host.innerHTML='<div class="small">Aucune r√®gle pour le moment.</div>'; return; }
  rulesArr.forEach((txt,i)=>{
    const row=document.createElement('div'); row.className='rule';
    row.innerHTML=`<span style="white-space:pre-wrap">${txt}</span><button class="btn ghost" data-del="${i}">Supprimer</button>`;
    row.querySelector('[data-del]').onclick=()=>{rulesArr.splice(i,1); saveLocal(); saveCloud(); renderRulesModal();};
    host.appendChild(row);
  });
}
document.getElementById('addRuleBtn').onclick=()=>{
  const v=document.getElementById('ruleInput').value.trim(); if(!v) return;
  rulesArr.push(v); document.getElementById('ruleInput').value='';
  saveLocal(); saveCloud();
};
document.getElementById('showRules').onclick=()=>{ renderRulesModal(); document.getElementById('rulesModal').classList.add('show'); };
document.getElementById('clearRules').onclick=()=>{ rulesArr=[]; saveLocal(); saveCloud(); };
document.getElementById('closeR').onclick=()=>document.getElementById('rulesModal').classList.remove('show');
document.getElementById('rb').onclick=()=>document.getElementById('rulesModal').classList.remove('show');

/*** 8) L√©gendes et onglets ***/
document.getElementById('imgClean').src=images.state_clean;
document.getElementById('imgWet').src=images.state_wet;
document.getElementById('imgMessy').src=images.state_messy;
document.getElementById('imgSlip').src=images.slip;
document.getElementById('sw').src=images.state_wet;
document.getElementById('sm').src=images.state_messy;
document.getElementById('ss').src=images.slip;

document.querySelectorAll('.tabs .tab').forEach(t=>t.onclick=()=>{
  document.querySelectorAll('.tabs .tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('show'));
  t.classList.add('active'); document.getElementById('tab-'+t.dataset.tab).classList.add('show');
});

/*** 9) Modale Jour ***/
const modal=document.getElementById('dayModal'); const mdDate=document.getElementById('mdDate'); const stateImg=document.getElementById('stateImg'); const checklist=document.getElementById('checklist'); const dayPtsEl=document.getElementById('dayPts'); let currentKey=null;
function openDay(k){
  currentKey=k; if(!entries[k]) entries[k]={diaperState:0,checks:{},diapersUsed:1,drinks:0};
  mdDate.textContent=new Date(k).toLocaleDateString('fr-FR',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  const st=Number(entries[k].diaperState)||0; const base=230; const extra=(st===2)?1.15:1.0;
  stateImg.width=Math.round(base*extra); stateImg.height=Math.round(base*extra);
  stateImg.src=(Number(entries[k].diapersUsed)===0)?images.slip:(st===2?images.state_messy:st===1?images.state_wet:images.state_clean);
  checklist.innerHTML='';
  tasks.forEach(t=>{
    const checked=!!entries[k].checks[t.id];
    const item=document.createElement('div'); item.className='check-item';
    item.innerHTML=`<img src="${t.icon}" alt=""><label style="display:flex;gap:10px;align-items:center;"><input type="checkbox" ${checked?'checked':''}><span>${t.name}</span><span class="small ${t.points>=0?'pos':'neg'}">(${t.points} pts)</span></label>`;
    const cb=item.querySelector('input'); cb.onchange=()=>{entries[k].checks[t.id]=cb.checked; saveLocal(); saveCloud(); updateDay();};
    checklist.appendChild(item);
  });
  document.querySelectorAll('.pills .pill').forEach(p=>{
    const n=Number(p.dataset.n);
    p.classList.toggle('active', Number(entries[k].diapersUsed)===n);
    p.onclick=()=>{ 
      entries[k].diapersUsed=n;
      if(n===0){ entries[k].diaperState=0; }
      saveLocal(); saveCloud(); openDay(k); renderCalendar(); 
    };
  });
  document.getElementById('drinksInput').value = Number(entries[k].drinks)||0;
  document.getElementById('drinksInput').onchange = (e)=>{
    entries[k].drinks = Math.max(0, Number(e.target.value)||0);
    saveLocal(); saveCloud(); updateDay();
  };
  document.getElementById('drinkPenaltyInfo').textContent = Math.abs(Number(rules.drink)||1);

  dayPtsEl.textContent=dayPoints(k);
  modal.classList.add('show');
}
function updateDay(){ if(!currentKey) return; dayPtsEl.textContent=dayPoints(currentKey); renderCalendar(); }
document.getElementById('closeM').onclick=()=>modal.classList.remove('show'); document.getElementById('mb').onclick=()=>modal.classList.remove('show');
document.querySelectorAll('[data-set]').forEach(b=>{ b.onclick=()=>{ entries[currentKey].diaperState=Number(b.dataset.set)||0; saveLocal(); saveCloud(); openDay(currentKey); renderCalendar(); }; });

/*** 10) R√©compenses & Punitions (CRUD) ***/
function renderRewardList(){
  const host=document.getElementById('rewardsList'); host.innerHTML='';
  if(!rewards.length){ host.innerHTML='<div class="small">Aucune r√©compense.</div>'; return; }
  rewards.forEach((it,idx)=>{
    const row=document.createElement('div'); row.className='item-row';
    row.innerHTML=`
      <div class="left">
        <input value="${it.label||''}" data-f="label" style="width:260px">
        <select data-f="scope"><option value="weekly"${it.scope==='weekly'?' selected':''}>Semaine</option><option value="monthly"${it.scope==='monthly'?' selected':''}>Mois</option></select>
        <input type="number" value="${it.threshold||0}" data-f="threshold" style="width:110px">
      </div>
      <div class="right"><button class="btn ghost" data-del="${idx}">Supprimer</button></div>`;
    row.querySelectorAll('input,select').forEach(el=>{
      el.onchange=()=>{
        const f=el.dataset.f;
        rewards[idx][f]= (f==='threshold') ? Number(el.value)||0 : el.value;
        saveLocal(); saveCloud();
      };
    });
    row.querySelector('[data-del]').onclick=()=>{rewards.splice(idx,1); saveLocal(); saveCloud(); renderRewardList();};
    host.appendChild(row);
  });
}
function renderPunishList(){
  const host=document.getElementById('punishList'); host.innerHTML='';
  if(!punishments.length){ host.innerHTML='<div class="small">Aucune punition.</div>'; return; }
  punishments.forEach((it,idx)=>{
    const row=document.createElement('div'); row.className='item-row';
    row.innerHTML=`
      <div class="left">
        <input value="${it.label||''}" data-f="label" style="width:260px">
        <select data-f="scope"><option value="weekly"${it.scope==='weekly'?' selected':''}>Semaine</option><option value="monthly"${it.scope==='monthly'?' selected':''}>Mois</option></select>
        <input type="number" value="${it.threshold||0}" data-f="threshold" style="width:110px">
      </div>
      <div class="right"><button class="btn ghost" data-del="${idx}">Supprimer</button></div>`;
    row.querySelectorAll('input,select').forEach(el=>{
      el.onchange=()=>{
        const f=el.dataset.f;
        punishments[idx][f]= (f==='threshold') ? Number(el.value)||0 : el.value;
        saveLocal(); saveCloud();
      };
    });
    row.querySelector('[data-del]').onclick=()=>{punishments.splice(idx,1); saveLocal(); saveCloud(); renderPunishList();};
    host.appendChild(row);
  });
}
document.getElementById('addReward').onsubmit=(e)=>{
  e.preventDefault();
  const label=document.getElementById('rewardLabel').value.trim();
  const scope=document.getElementById('rewardScope').value;
  const threshold=Number(document.getElementById('rewardThreshold').value)||0;
  if(!label) return;
  rewards.push({label,scope,threshold}); e.target.reset(); saveLocal(); saveCloud(); renderRewardList();
};
document.getElementById('addPunish').onsubmit=(e)=>{
  e.preventDefault();
  const label=document.getElementById('punishLabel').value.trim();
  const scope=document.getElementById('punishScope').value;
  const threshold=Number(document.getElementById('punishThreshold').value)||0;
  if(!label) return;
  punishments.push({label,scope,threshold}); e.target.reset(); saveLocal(); saveCloud(); renderPunishList();
};

/*** 11) Bootstrapping ***/
function renderAll(){ renderTaskList(); renderPointsEditor(); renderGoalsList(); renderRewardList(); renderPunishList(); renderCalendar(); }
(async function init(){
  try{
    const snap=await docRef.get();
    if(snap.exists){
      const data=snap.data();
      if(data.tasks) tasks=data.tasks;
      if(data.images) images=data.images;
      if(data.entries) entries=data.entries;
      if(data.rules) rules=data.rules;
      if(data.thresholds) thresholds=data.thresholds;
      if(Array.isArray(data.rewards)) rewards=data.rewards;
      if(Array.isArray(data.punishments)) punishments=data.punishments;
      if(Array.isArray(data.rulesArr)) rulesArr=data.rulesArr;
      saveLocal();
    }else{
      await docRef.set({_clientId:clientId, createdAt:Date.now(), tasks, images, rules, thresholds, rewards, punishments, rulesArr, entries});
    }
  }catch(e){ console.warn('Init cloud error', e); }
  renderAll();
})();

</script>
</body>
</html>
