<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Diaper Tracker</title>
<style>
*{box-sizing:border-box}html,body{margin:0;padding:0}
:root{--ink:#27314a;--muted:#6e7a96;--card:#fff;--brand:#6a8dff;--line:#e9e6ff;--green:#1a7f37;--red:#d32f2f;--pink:#ff9fc7}
body{font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#fffaff,#f7fbff);color:var(--ink)}
.container{max-width:1320px;margin:8px auto;padding:12px;display:grid;grid-template-columns:360px 1fr;gap:16px}
.panel,.calendar-card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px}
.btn{border:none;border-radius:10px;padding:8px 12px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--line);color:#1a2442}
.grid{display:grid;gap:8px}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
h1{margin:10px 0 0;text-align:center;font-family:'Comic Sans MS','Baloo 2','Quicksand',cursive;font-weight:800;letter-spacing:.5px;color:#ff86bd;text-shadow:0 1px 0 #ffe3ef, 0 3px 8px rgba(255,134,189,.25);font-size:28px}
.subtitle{text-align:center;color:var(--muted);margin-bottom:8px}
.tabs{display:flex;gap:10px;margin:6px 0;justify-content:space-between}
.tabs img.tab{width:72px;height:72px;padding:4px;border-radius:14px;border:2px solid var(--line);background:#fff;cursor:pointer;transition:.2s}
.tabs img.tab.active{border-color:#ffc7de;box-shadow:0 0 0 4px #fff, 0 0 0 6px #ffe6f2}
.tab-content{display:none}.tab-content.show{display:block}
.cal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.month-label{font-weight:800}
.cal-grid{display:grid;grid-template-columns:repeat(7,minmax(80px,1fr));gap:3px}
.day-head{color:var(--muted);text-align:center;font-weight:700;font-size:12px}
.day{min-height:100px;border:1px solid var(--line);border-radius:10px;padding:4px;display:grid;grid-template-rows:auto 1fr auto;gap:2px;cursor:pointer;background:#fff}
.day .num{font-weight:800;font-size:12px}
.day .thumb{display:flex;align-items:center;justify-content:center}
.day .thumb img{width:64px;height:64px;object-fit:contain}
.day .pts{justify-self:end;font-weight:700;font-size:11px}
.legend-panel{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:6px}
.legend-panel .it{display:flex;align-items:center;gap:6px;border:1px dashed var(--line);border-radius:999px;padding:4px 8px}
.legend-panel img{width:28px;height:28px;object-fit:contain}
.progress{display:grid;gap:8px;margin-bottom:8px}
.progress-row{display:grid;grid-template-columns:84px 1fr max-content;gap:8px;align-items:center}
.progress-row .bar{height:10px;background:#f5f6ff;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.progress-row .bar>div{height:100%;width:0;background:linear-gradient(90deg,#ffdbec,#ff86bd);transition:width .3s}
.stat-line{display:flex;justify-content:space-between;margin-top:4px}
.small{color:#6e7a96;font-size:12px}
.pos{color:#1a7f37;font-weight:700}.neg{color:#d32f2f;font-weight:700}
.goal{font-size:12px;font-weight:700}
.modal{position:fixed;inset:0;display:none}
.modal.show{display:block}
.modal-backdrop{position:absolute;inset:0;background:rgba(29,35,58,.45)}
.modal-body{position:relative;background:#fff;border-radius:16px;padding:12px;border:1px solid var(--line);width:min(960px,calc(100% - 24px));margin:40px auto;max-height:90vh;overflow:auto}
.section{margin-top:8px}.section.compact{margin-top:4px}
.checklist{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.check-item{border:1px dashed var(--line);border-radius:12px;padding:10px;display:flex;align-items:center;gap:14px}
.check-item img{width:110px;height:110px;object-fit:contain}
.state-row{display:flex;justify-content:center;align-items:center;gap:20px}
.state-controls{display:grid;gap:8px;align-content:center;justify-items:start}
#stateImg{display:block;margin:0 auto}
.pills .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;cursor:pointer}
.pill.active{background:#edf2ff;border-color:#c7d2fe}
.badge{display:inline-block;background:#edf2ff;color:#334;padding:4px 8px;border-radius:999px;font-size:12px}
.textarea{width:100%;min-height:120px;border:1px solid var(--line);border-radius:10px;padding:10px;resize:vertical}
.rule{border:1px dashed var(--line);border-radius:10px;padding:8px;display:flex;justify-content:space-between;align-items:center}
hr{border:none;border-top:1px dashed var(--line);margin:10px 0}
.task-row{display:flex;justify-content:space-between;align-items:center;border:1px dashed var(--line);border-radius:10px;padding:8px}
.task-row .left{display:flex;align-items:center;gap:8px}
.objkid{font-family:'Comic Sans MS','Baloo 2','Quicksand',cursive;font-size:16.5px;line-height:1.5}
#syncBadge{position:fixed;top:8px;right:8px;background:#fff;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;box-shadow:0 4px 14px rgba(0,0,0,.06)}
</style>
</head>
<body>
<div id="syncBadge">Hors ligne…</div>
<h1>Diaper Tracker</h1>
<div class="subtitle">suivie pour apprendre à devenir un vrai bébé</div>
<main class="container">
  <aside class="panel">
    <div class="tabs">
      <img class="tab active" data-tab="actions" src="images/action.webp" alt="Actions">
      <img class="tab" data-tab="objectifs" src="images/objectif.webp" alt="Objectifs">
      <img class="tab" data-tab="rules" src="images/regles-bebe.webp" alt="Règles de bébé">
      <img class="tab" data-tab="points" src="images/points.webp" alt="Modifier points">
    </div>

    <div id="tab-actions" class="tab-content show">
      <h3>Compteurs</h3>
      <div class="progress">
        <div class="progress-row"><div>Semaine</div><div class="bar"><div id="weeklyBar"></div></div><div><b id="weeklyPts">0</b> pts<br><span id="weeklyGoal" class="goal"></span></div></div>
        <div class="progress-row"><div>Mois</div><div class="bar"><div id="monthlyBar"></div></div><div><b id="monthlyPts">0</b> pts<br><span id="monthlyGoal" class="goal"></span></div></div>
        <div class="progress-row"><div>Couches</div><div class="bar"><div id="diapersBar"></div></div><div><b id="monthDiapers">0</b> utilisées</div></div>
      </div>
      <hr/>

      <h3>Créer une action</h3>
      <form id="addTaskForm" class="grid" style="margin-top:6px">
        <input id="taskName" placeholder="Nom de l'action" required>
        <input id="taskPoints" type="number" placeholder="Points (+/-)" required>
        <div class="flex">
          <label class="btn ghost" for="taskSticker">Choisir une image</label>
          <input id="taskSticker" type="file" accept="image/*" style="display:none">
          <button class="btn">Ajouter</button>
        </div>
      </form>

      <div class="legend-panel">
        <div class="it"><img id="imgClean" alt=""><span>propre</span><span class="small">(0 pt)</span></div>
        <div class="it"><img id="imgWet" alt=""><span>pipi</span><span class="small">= <b id="wetPts">2</b> pts</span></div>
        <div class="it"><img id="imgMessy" alt=""><span>sale</span><span class="small">+ <b id="salePts">5</b> pts</span></div>
        <div class="it"><img id="imgSlip" alt=""><span>slip (0 couche)</span><span class="small"><b id="zeroPts">-5</b> pts</span></div>
      </div>

      <h3 style="margin-top:8px">Actions existantes</h3>
      <div id="taskList" class="grid"></div>
    </div>

    <div id="tab-objectifs" class="tab-content">
      <h3>Badges à débloquer</h3>
      <ul class="small objkid" id="goalsList">
        <li><b>Semaine</b>: 30 → Jeune enfant · 50 → Apprentie bébé · 80 → Bébé à sa maman</li>
        <li><b>Mois</b>: 100 → Quitte le monde des adultes · 200 → devient un bébé · 300 → Vrai bébé</li>
      </ul>
      <h4 style="margin-top:10px">Récompenses</h4>
      <div id="rewards" class="grid small"></div>
      <div class="flex">
        <input id="rewardText" placeholder="Ajouter une récompense">
        <button class="btn" id="addReward">Ajouter</button>
      </div>
      <h4>Punitions</h4>
      <div id="punishments" class="grid small"></div>
      <div class="flex">
        <input id="punishText" placeholder="Ajouter une punition">
        <button class="btn" id="addPunish">Ajouter</button>
      </div>
    </div>

    <div id="tab-rules" class="tab-content">
      <h3>Règle de bébé</h3>
      <div class="grid">
        <textarea id="ruleInput" class="textarea" placeholder="Colle ici un (grand) texte de règles…"></textarea>
        <div class="flex">
          <button class="btn" id="addRules">Enregistrer</button>
          <button class="btn ghost" id="showRules">Règles</button>
          <button class="btn ghost" id="clearRules">Tout effacer</button>
        </div>
      </div>
    </div>

    <div id="tab-points" class="tab-content">
      <h3>Modifier les points</h3>
      <div class="grid small">
        <div class="task-row"><div class="left"><img id="sw" style="width:24px;height:24px"><span>Pipi</span></div><input id="wetPtsInput" type="number" value="2" style="width:90px"></div>
        <div class="task-row"><div class="left"><img id="sm" style="width:24px;height:24px"><span>Sale</span></div><input id="salePtsInput" type="number" value="5" style="width:90px"></div>
        <div class="task-row"><div class="left"><img id="ss" style="width:24px;height:24px"><span>0 couche (slip)</span></div><input id="zeroPtsInput" type="number" value="-5" style="width:90px"></div>
        <div class="task-row"><div class="left"><span>Points - 1/verre</span></div><input id="drinkPenaltyInput" type="number" value="1" style="width:90px"></div>
        <hr>
        <div id="pointsTaskList" class="grid"></div>
        <button class="btn" id="savePoints">Enregistrer</button>
      </div>
    </div>
  </aside>

  <section class="calendar-card">
    <div class="cal-head">
      <button class="btn ghost" id="prevMonth">←</button>
      <div class="month-label" id="monthLabel"></div>
      <button class="btn ghost" id="nextMonth">→</button>
    </div>
    <div class="cal-grid" id="calGrid"></div>
  </section>
</main>

<div class="modal" id="dayModal">
  <div class="modal-backdrop" id="mb"></div>
  <div class="modal-body">
    <div class="flex" style="justify-content:space-between">
      <h3 id="mdDate">—</h3>
      <button class="btn ghost" id="closeM">Fermer</button>
    </div>
    <div class="section compact">
      <h4>État de la couche</h4>
      <div class="state-row">
        <img id="stateImg" src="" width="230" height="230" style="object-fit:contain">
        <div class="state-controls">
          <button class="btn ghost" data-set="0">Propre</button>
          <button class="btn ghost" data-set="1">Pipi</button>
          <button class="btn ghost" data-set="2">Sale</button>
        </div>
      </div>
    </div>
    <div class="section compact">
      <h4>Actions du jour</h4>
      <div id="checklist" class="checklist"></div>
    </div>
    <div class="section compact">
      <h4>Couches utilisées (statistique)</h4>
      <div class="pills flex">
        <span class="pill" data-n="0">0</span><span class="pill" data-n="1">1</span><span class="pill" data-n="2">2</span><span class="pill" data-n="3">3</span><span class="pill" data-n="4">4</span>
      </div>
      <div class="small">Sélectionner <b>0</b> affichera le <b>slip</b> pour la journée et appliquera -5 points.</div>
    </div>
    <div class="section compact">
      <h4>Boissons (verres)</h4>
      <input id="drinkCount" type="number" min="0" value="0" style="width:120px">
    </div>
    <div class="section compact">
      <div class="stat-line"><span>Points du jour</span><b id="dayPts">0</b></div>
    </div>
  </div>
</div>

<div class="modal" id="rulesModal">
  <div class="modal-backdrop" id="rb"></div>
  <div class="modal-body">
    <div class="flex" style="justify-content:space-between">
      <h3>Règles de bébé</h3>
      <button class="btn ghost" id="closeR">Fermer</button>
    </div>
    <div id="rulesList" class="grid" style="margin-top:8px"></div>
  </div>
</div>

<!-- Firebase SDK (CDN modules) -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

// --- Firebase config fourni par ta capture ---
const firebaseConfig = {
  apiKey: "AIzaSyAmSVQKKqm9X9vUyV7XQsg5Jt2K2rXL-wM",
  authDomain: "dl-track.firebaseapp.com",
  projectId: "dl-track",
  storageBucket: "dl-track.firebasestorage.app",
  messagingSenderId: "126725220245",
  appId: "1:126725220245:web:4bc43252a9c91deadf789c",
  measurementId: "G-9M4P6O8Q8SYD"
};

// App & DB
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// --- Utilitaires UI ---
const KEYS={entries:'dt_v7c_entries',tasks:'dt_v7c_tasks',rules:'dt_v7c_rules',images:'dt_v7c_images',babyRules:'dt_v7c_baby_rules',goals:'dt_v7c_goals',rewards:'dt_v7c_rewards',punish:'dt_v7c_punish'};
function qs(id){return document.getElementById(id)}
const syncBadge = qs('syncBadge');
function setSync(t){syncBadge.textContent=t}

// --- Données locales par défaut ---
let rules=JSON.parse(localStorage.getItem(KEYS.rules)||'null')||{wet:2,sale:5,zero:-5,drinkPenalty:1};
let tasks=JSON.parse(localStorage.getItem(KEYS.tasks)||'null')||[
 {id:'no_alcohol',name:'No alcohol',points:1,icon:'images/no_alcohol.webp'},
 {id:'exercise',name:'Sport',points:2,icon:'images/sport.webp'},
 {id:'eat_healthy',name:'Manger sainement',points:2,icon:'images/healthy.webp'},
 {id:'house_task',name:'Ménage',points:1,icon:'images/cleaning.webp'},
 {id:'public_diaper',name:'Couche en public',points:2,icon:'images/diaper_public.webp'},
 {id:'friends_diaper',name:'couche avec des amis',points:5,icon:'images/diaper_friend.webp'},
 {id:'diaper_family',name:'Porter des couches en famille',points:20,icon:'images/diaper_family.webp'}
];
let images=JSON.parse(localStorage.getItem(KEYS.images)||'null')||{
 state_clean:'images/diaper_clean.webp',
 state_wet:'images/diaper_wet.webp',
 state_messy:'images/diaper_messy.webp',
 slip:'images/slip.webp',
 body:'images/body.webp'
};
let goals=JSON.parse(localStorage.getItem(KEYS.goals)||'null')||{
  week:[{t:30,l:'Jeune enfant'},{t:50,l:'Apprentie bébé'},{t:80,l:'Bébé à sa maman'}],
  month:[{t:100,l:'Quitte le monde des adultes'},{t:200,l:'devient un bébé'},{t:300,l:'Vrai bébé'}]
};
let rewards=JSON.parse(localStorage.getItem(KEYS.rewards)||'[]');
let punish=JSON.parse(localStorage.getItem(KEYS.punish)||'[]');
let entries=JSON.parse(localStorage.getItem(KEYS.entries)||'{}');
let babyRules=JSON.parse(localStorage.getItem(KEYS.babyRules)||'[]');

function saveLocal(){
  localStorage.setItem(KEYS.tasks,JSON.stringify(tasks));
  localStorage.setItem(KEYS.images,JSON.stringify(images));
  localStorage.setItem(KEYS.entries,JSON.stringify(entries));
  localStorage.setItem(KEYS.rules,JSON.stringify(rules));
  localStorage.setItem(KEYS.goals,JSON.stringify(goals));
  localStorage.setItem(KEYS.rewards,JSON.stringify(rewards));
  localStorage.setItem(KEYS.punish,JSON.stringify(punish));
  localStorage.setItem(KEYS.babyRules,JSON.stringify(babyRules));
}

// --- Espace partagé (via ?space=) ---
const params=new URLSearchParams(location.search);
const spaceId=params.get('space')||'default';
const spaceRef=doc(db,'spaces',spaceId);

// Merge cloud->local
function applyRemote(data){
  if(!data) return;
  if(data.tasks) tasks=data.tasks;
  if(data.rules) rules=data.rules;
  if(data.images) images=data.images;
  if(data.entries) entries=data.entries;
  if(data.goals) goals=data.goals;
  if(data.rewards) rewards=data.rewards;
  if(data.punish) punish=data.punish;
  if(data.babyRules) babyRules=data.babyRules;
  saveLocal(); renderAll();
}

// Push local->cloud (debounce)
let saveTimer=null;
async function pushRemote(){
  clearTimeout(saveTimer);
  saveTimer=setTimeout(async()=>{
    try{
      setSync('Connexion…');
      await setDoc(spaceRef,{
        tasks,rules,images,entries,goals,rewards,punish,babyRules,updatedAt:serverTimestamp()
      },{merge:true});
      setSync('En ligne');
    }catch(e){ console.error(e); setSync('Hors ligne…'); }
  },300);
}

// Initial read + live updates
(async()=>{
  try{
    setSync('Connexion…');
    const snap=await getDoc(spaceRef);
    if(!snap.exists()){
      await setDoc(spaceRef,{tasks,rules,images,entries,goals,rewards,punish,babyRules,createdAt:serverTimestamp()});
    }else{
      applyRemote(snap.data());
    }
    onSnapshot(spaceRef,(s)=>{ if(s.exists()) applyRemote(s.data()); });
    setSync('En ligne');
  }catch(e){ console.error(e); setSync('Hors ligne…'); }
})();

// ---------- UI logique (identique à V7) ----------
function ensureDay(k){ if(!entries[k]) entries[k]={diaperState:0,checks:{},diapersUsed:1,drinks:0}; }
function fmt(d){return d.toISOString().slice(0,10);}

// Legend
qs('imgClean').src=images.state_clean;
qs('imgWet').src=images.state_wet;
qs('imgMessy').src=images.state_messy;
qs('imgSlip').src=images.slip;
qs('sw').src=images.state_wet;
qs('sm').src=images.state_messy;
qs('ss').src=images.slip;

// Tabs
document.querySelectorAll('.tabs .tab').forEach(t=>t.onclick=()=>{
  document.querySelectorAll('.tabs .tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('show'));
  t.classList.add('active'); qs('tab-'+t.dataset.tab).classList.add('show');
});

function dayPoints(key){
  ensureDay(key);
  const d = entries[key];
  const st = Number(d.diaperState)||0;
  const isZero = Number(d.diapersUsed)===0;
  const wetPts = Number.isFinite(Number(rules.wet))?Number(rules.wet):0;
  const salePts = Number.isFinite(Number(rules.sale))?Number(rules.sale):0;
  const zeroPenalty = isZero ? (Number.isFinite(Number(rules.zero))?Number(rules.zero):-5) : 0;
  const drinkPenalty = (Number.isFinite(Number(rules.drinkPenalty))?Number(rules.drinkPenalty):1) * (Number(d.drinks)||0) * -1;
  const diaperPts = isZero ? 0 : ((st>=1?wetPts:0)+(st===2?salePts:0));
  const checksPts = Object.entries(d.checks).reduce((s,[id,v])=>{
    if(!v) return s; const t=tasks.find(t=>t.id===id); const p=Number(t&&t.points); return s+(Number.isFinite(p)?p:0);
  },0);
  return diaperPts+checksPts+zeroPenalty+drinkPenalty;
}
function dayPointsSafe(k){return entries[k]?dayPoints(k):0;}

// Calendar
const calGrid=qs('calGrid'); const monthLabel=qs('monthLabel'); let viewing=new Date(); viewing.setDate(1);
function firstWeekday(y,m){return (new Date(y,m,1).getDay()+6)%7;}
function daysInMonth(y,m){return new Date(y,m+1,0).getDate();}
function renderCalendar(){
  calGrid.innerHTML='';
  const days=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim']; days.forEach(n=>{const h=document.createElement('div');h.className='day-head';h.textContent=n;calGrid.appendChild(h);});
  const y=viewing.getFullYear(),m=viewing.getMonth(); monthLabel.textContent=new Date(y,m,1).toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
  for(let i=0;i<firstWeekday(y,m);i++){const b=document.createElement('div');b.className='day';b.style.visibility='hidden';calGrid.appendChild(b);}
  const total=daysInMonth(y,m);
  for(let d=1; d<=total; d++){
    const key=fmt(new Date(y,m,d,12));
    const st=(entries[key]&&entries[key].diaperState)||0;
    let img=null;
    if(!entries[key]){ img=images.body; }
    else if(Number(entries[key].diapersUsed)===0){ img=images.slip; }
    else { img = st===2?images.state_messy: st===1?images.state_wet: images.state_clean; }
    const cell=document.createElement('div'); cell.className='day';
    cell.innerHTML=`<div class="num">${d}</div><div class="thumb">${img?`<img src="${img}" alt="">`:''}</div><div class="pts">${dayPointsSafe(key)} pts</div>`;
    cell.onclick=()=>openDay(key); calGrid.appendChild(cell);
  }
  // weekly / monthly + diapers
  const now=new Date(); const s=(d=>{const x=new Date(d);x.setHours(0,0,0,0);const k=(x.getDay()+6)%7;x.setDate(x.getDate()-k);return x;})(now);
  let w=0; for(let i=0;i<7;i++){const d=new Date(s);d.setDate(s.getDate()+i); w+=dayPointsSafe(fmt(d));}
  let mo=0; const todayKey = fmt(new Date()); const y2=viewing.getFullYear(),m2=viewing.getMonth(),total2=daysInMonth(y2,m2);
  let used=0, elapsed=0;
  for(let d=1; d<=total2; d++){ const k=fmt(new Date(y2,m2,d,12)); if(k<=todayKey){ elapsed++; mo+=dayPointsSafe(k); if(entries[k]&&Number.isFinite(Number(entries[k].diapersUsed))) used+=Number(entries[k].diapersUsed)||0; } }
  const maxDiapers=Math.max(1, elapsed*4);
  qs('weeklyPts').textContent=w; qs('monthlyPts').textContent=mo; qs('monthDiapers').textContent=used;
  qs('weeklyBar').style.width=Math.min(100,Math.round(100*w/100))+'%';
  qs('monthlyBar').style.width=Math.min(100,Math.round(100*mo/400))+'%';
  qs('diapersBar').style.width=Math.min(100,Math.round(100*used/maxDiapers))+'%';
  // goals display text (uses defaults)
  const wg = (w>=80?'Bébé à sa maman':w>=50?'Apprentie bébé':w>=30?'Jeune enfant':'');
  const mg = (mo>=300?'Vrai bébé':mo>=200?'devient un bébé':mo>=100?'Quitte le monde des adultes':'');
  qs('weeklyGoal').textContent=wg; qs('monthlyGoal').textContent=mg;
}
function renderGoalsList(){
  const host=qs('goalsList'); host.innerHTML=`
    <li><b>Semaine</b>: ${goals.week.map(g=>`${g.t} → ${g.l}`).join(' · ')}</li>
    <li><b>Mois</b>: ${goals.month.map(g=>`${g.t} → ${g.l}`).join(' · ')}</li>
  `;
}
function renderTaskList(){
  const host=qs('taskList'); host.innerHTML='';
  tasks.forEach((t,i)=>{
    const row=document.createElement('div'); row.className='task-row';
    row.innerHTML=\`<div class="left"><img src="\${t.icon}" style="width:28px;height:28px;object-fit:contain"><span>\${t.name}</span><span class="\${t.points>=0?'pos':'neg'} small">(\${t.points} pts)</span></div><button class="btn ghost" data-del="\${i}">Supprimer</button>\`;
    row.querySelector('[data-del]').onclick=()=>{tasks.splice(i,1); saveLocal(); pushRemote(); renderTaskList(); renderPointsEditor();};
    host.appendChild(row);
  });
}
function renderPointsEditor(){
  const host=qs('pointsTaskList'); host.innerHTML='';
  tasks.forEach((t,i)=>{
    const row=document.createElement('div'); row.className='task-row';
    row.innerHTML=\`<div class="left"><img src="\${t.icon}" style="width:24px;height:24px"><span>\${t.name}</span></div><input type="number" value="\${t.points}" data-pts="\${i}" style="width:90px">\`;
    row.querySelector('input').onchange=(e)=>{tasks[i].points=Number(e.target.value)||0; saveLocal(); pushRemote();};
    host.appendChild(row);
  });
}
function renderRewardsPunish(){
  const rw=qs('rewards'); rw.innerHTML=''; rewards.forEach((r,i)=>{const d=document.createElement('div'); d.className='rule'; d.innerHTML=\`<span>\${r}</span><button class="btn ghost" data-i="\${i}">Supprimer</button>\`; d.querySelector('button').onclick=()=>{rewards.splice(i,1); saveLocal(); pushRemote(); renderRewardsPunish();}; rw.appendChild(d);} );
  const pu=qs('punishments'); pu.innerHTML=''; punish.forEach((p,i)=>{const d=document.createElement('div'); d.className='rule'; d.innerHTML=\`<span>\${p}</span><button class="btn ghost" data-i="\${i}">Supprimer</button>\`; d.querySelector('button').onclick=()=>{punish.splice(i,1); saveLocal(); pushRemote(); renderRewardsPunish();}; pu.appendChild(d);} );
}
function renderAll(){ renderCalendar(); renderTaskList(); renderPointsEditor(); renderGoalsList(); renderRewardsPunish(); }

// Add task
qs('addTaskForm').onsubmit=(e)=>{
  e.preventDefault();
  const name=qs('taskName').value.trim();
  const pts=Number(qs('taskPoints').value);
  const file=qs('taskSticker').files[0];
  if(!name || !Number.isFinite(pts)) return;
  function add(icon){
    tasks.push({id:name.toLowerCase().replace(/[^a-z0-9]+/g,'_'),name,points:pts,icon:icon||'images/diaper_clean.webp'});
    qs('addTaskForm').reset(); saveLocal(); pushRemote(); renderTaskList(); renderPointsEditor();
  }
  if(file){const r=new FileReader(); r.onload=e=>add(e.target.result); r.readAsDataURL(file);} else add('images/diaper_clean.webp');
};

// Save points and thresholds
qs('savePoints').onclick=()=>{
  rules.wet=Number(qs('wetPtsInput').value)||0;
  rules.sale=Number(qs('salePtsInput').value)||0;
  rules.zero=Number(qs('zeroPtsInput').value); if(!Number.isFinite(rules.zero)) rules.zero=-5;
  rules.drinkPenalty=Number(qs('drinkPenaltyInput').value)||1;
  saveLocal(); pushRemote(); renderCalendar(); renderPointsEditor();
  qs('wetPts').textContent=rules.wet; qs('salePts').textContent=rules.sale; qs('zeroPts').textContent=rules.zero;
};

// Rules
function renderRulesList(){
  const host=qs('rulesList'); host.innerHTML='';
  if(!babyRules.length){ host.innerHTML='<div class="small">Aucune règle pour le moment.</div>'; return; }
  babyRules.forEach((r,i)=>{
    const row=document.createElement('div'); row.className='rule';
    row.innerHTML=\`<span style="white-space:pre-wrap">\${r}</span><button class="btn ghost" data-del="\${i}">Supprimer</button>\`;
    row.querySelector('[data-del]').onclick=()=>{babyRules.splice(i,1); saveLocal(); pushRemote(); renderRulesList();};
    host.appendChild(row);
  });
}
qs('addRules').onclick=()=>{
  const raw=qs('ruleInput').value; if(!raw.trim()) return;
  babyRules.push(raw); qs('ruleInput').value=''; saveLocal(); pushRemote();
};
qs('showRules').onclick=()=>{ renderRulesList(); qs('rulesModal').classList.add('show'); };
qs('clearRules').onclick=()=>{ babyRules=[]; saveLocal(); pushRemote(); };
qs('closeR').onclick=()=>qs('rulesModal').classList.remove('show');
qs('rb').onclick=()=>qs('rulesModal').classList.remove('show');

// Day modal
const modal=qs('dayModal'); const mdDate=qs('mdDate'); const stateImg=qs('stateImg'); const checklist=qs('checklist'); const dayPtsEl=qs('dayPts'); const drinkCount=qs('drinkCount'); let currentKey=null;
function openDay(k){
  currentKey=k; ensureDay(k);
  mdDate.textContent=new Date(k).toLocaleDateString('fr-FR',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  const st=Number(entries[k].diaperState)||0; const base=230; const extra=(st===2)?1.15:1.0;
  stateImg.width=Math.round(base*extra); stateImg.height=Math.round(base*extra);
  stateImg.src=(Number(entries[k].diapersUsed)===0)?images.slip:(st===2?images.state_messy:st===1?images.state_wet:images.state_clean);
  checklist.innerHTML='';
  tasks.forEach(t=>{
    const checked=!!entries[k].checks[t.id];
    const item=document.createElement('div'); item.className='check-item';
    item.innerHTML=\`<img src="\${t.icon}" alt=""><label style="display:flex;gap:10px;align-items:center;"><input type="checkbox" \${checked?'checked':''}><span>\${t.name}</span><span class="small \${t.points>=0?'pos':'neg'}">(\${t.points} pts)</span></label>\`;
    const cb=item.querySelector('input'); cb.onchange=()=>{entries[k].checks[t.id]=cb.checked; saveLocal(); pushRemote(); updateDay();};
    checklist.appendChild(item);
  });
  document.querySelectorAll('.pills .pill').forEach(p=>{
    const n=Number(p.dataset.n);
    p.classList.toggle('active', Number(entries[k].diapersUsed)===n);
    p.onclick=()=>{ entries[k].diapersUsed=n; if(n===0){ entries[k].diaperState=0; } saveLocal(); pushRemote(); openDay(k); renderCalendar(); };
  });
  drinkCount.value = Number(entries[k].drinks)||0;
  drinkCount.onchange = ()=>{ entries[k].drinks = Math.max(0, Number(drinkCount.value)||0); saveLocal(); pushRemote(); updateDay(); };
  dayPtsEl.textContent=dayPoints(k);
  modal.classList.add('show');
}
function updateDay(){ if(!currentKey) return; dayPtsEl.textContent=dayPoints(currentKey); renderCalendar(); }
qs('closeM').onclick=()=>modal.classList.remove('show'); qs('mb').onclick=()=>modal.classList.remove('show');
document.querySelectorAll('[data-set]').forEach(b=>{ b.onclick=()=>{ entries[currentKey].diaperState=Number(b.dataset.set)||0; saveLocal(); pushRemote(); openDay(currentKey); renderCalendar(); }; });

// Month nav + initial render
qs('prevMonth').onclick=()=>{viewing.setMonth(viewing.getMonth()-1);renderCalendar();};
qs('nextMonth').onclick=()=>{viewing.setMonth(viewing.getMonth()+1);renderCalendar();};
renderAll();
</script>
</body>
</html>
