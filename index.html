<!DOCTYPE html>
<html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Diaper tracker V5 — dense v2</title>
<style>
*{box-sizing:border-box}html,body{margin:0;padding:0}
:root{--ink:#27314a;--muted:#6e7a96;--card:#fff;--brand:#6a8dff;--line:#e9e6ff;--green:#1a7f37;--red:#d32f2f}
body{font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#fffaff,#f7fbff);color:var(--ink)}
.container{max-width:1320px;margin:8px auto;padding:12px;display:grid;grid-template-columns:360px 1fr;gap:16px}
.panel,.calendar-card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px}
.btn{border:none;border-radius:10px;padding:8px 12px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--line);color:#1a2442}
.grid{display:grid;gap:8px}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
h1{margin:8px 0 0;text-align:center}
.subtitle{text-align:center;color:var(--muted);margin-bottom:8px}
.cal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.month-label{font-weight:800}
/* denser calendar: smaller cells but keep 64x64 thumbs */
.cal-grid{display:grid;grid-template-columns:repeat(7,minmax(100px,1fr));gap:4px}
.day-head{color:var(--muted);text-align:center;font-weight:700;font-size:12px}
.day{min-height:120px;border:1px solid var(--line);border-radius:10px;padding:4px;display:grid;grid-template-rows:auto 1fr auto;gap:2px;cursor:pointer;background:#fff}
.day .num{font-weight:800;font-size:12px}
.day .thumb{display:flex;align-items:center;justify-content:center}
.day .thumb img{width:64px;height:64px;object-fit:contain}  /* unchanged */
.day .pts{justify-self:end;font-weight:700;font-size:11px}
.legend-panel{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:6px}
.legend-panel .it{display:flex;align-items:center;gap:6px;border:1px dashed var(--line);border-radius:999px;padding:4px 8px}
.legend-panel img{width:36px;height:36px;object-fit:contain}
.progress{display:grid;gap:8px;margin-bottom:8px}
.progress-row{display:grid;grid-template-columns:84px 1fr max-content;gap:8px;align-items:center}
.progress-row .bar{height:10px;background:#f5f6ff;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.progress-row .bar>div{height:100%;width:0;background:linear-gradient(90deg,#bcd1ff,var(--brand));transition:width .3s}
.stat-line{display:flex;justify-content:space-between;margin-top:4px}
.small{color:var(--muted);font-size:12px}
.pos{color:var(--green);font-weight:700} .neg{color:#d32f2f;font-weight:700}
.modal{position:fixed;inset:0;display:none}
.modal.show{display:block}
.modal-backdrop{position:absolute;inset:0;background:rgba(29,35,58,.45)}
.modal-body{position:relative;background:#fff;border-radius:16px;padding:12px;border:1px solid var(--line);width:min(900px,calc(100% - 24px));margin:40px auto}
.section{margin-top:8px}
/* Reduce space between top diaper and actions */
.section.compact{margin-top:4px}
/* checklist with 170% bigger icons relative to previous 48px => ~82px */
.checklist{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.check-item{border:1px dashed var(--line);border-radius:12px;padding:10px;display:flex;align-items:center;gap:10px}
.check-item img{width:82px;height:82px;object-fit:contain}
/* Center the state image row */
.state-row{display:flex;justify-content:center;align-items:center;gap:12px}
#stateImg{display:block;margin:0 auto}
.pills .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;cursor:pointer}
.pill.active{background:#edf2ff;border-color:#c7d2fe}
.badge{display:inline-block;background:#edf2ff;color:#334;padding:4px 8px;border-radius:999px;font-size:12px}
.textarea{width:100%;min-height:80px;border:1px solid var(--line);border-radius:10px;padding:10px;resize:vertical}
.rule{border:1px dashed var(--line);border-radius:10px;padding:8px;display:flex;justify-content:space-between;align-items:center}
hr{border:none;border-top:1px dashed var(--line);margin:10px 0}
@media(max-width:1100px){.container{grid-template-columns:1fr}.cal-grid{grid-template-columns:repeat(7,minmax(90px,1fr))}.day{min-height:110px}}
</style>
</head>
<body>
<script>
const KEYS = { entries:'dt_v5_entries', tasks:'dt_v5_tasks', rules:'dt_v5_rules', images:'dt_v5_images', babyRules:'dt_v5_baby_rules' };

let rules = JSON.parse(localStorage.getItem(KEYS.rules)||'null')||{wet:2, sale:5};
let tasks = JSON.parse(localStorage.getItem(KEYS.tasks)||'null')||[
  {id:'no_alcohol',name:'No alcohol',points:1,icon:'images/no_alcohol.webp'},
  {id:'exercise',name:'Sport',points:2,icon:'images/sport.webp'},
  {id:'eat_healthy',name:'Manger sainement',points:2,icon:'images/healthy.webp'},
  {id:'house_task',name:'Ménage',points:1,icon:'images/cleaning.webp'},
  {id:'public_diaper',name:'Couche en public',points:2,icon:'images/diaper_public.webp'},
  {id:'big_visible_public',name:'Grosse couche visible en public',points:5,icon:'images/diaper_friend.webp'},
  {id:'diaper_family',name:'Porter des couches en famille',points:20,icon:'images/diaper_family.webp'}
];
let images = JSON.parse(localStorage.getItem(KEYS.images)||'null')||{
  state_clean: 'images/diaper_clean.webp',
  state_wet:   'images/diaper_wet.webp',
  state_messy: 'images/diaper_messy.webp'
};
let entries = JSON.parse(localStorage.getItem(KEYS.entries)||'{}');
let babyRules = JSON.parse(localStorage.getItem(KEYS.babyRules)||'[]');

function saveAll(){
  localStorage.setItem(KEYS.tasks, JSON.stringify(tasks));
  localStorage.setItem(KEYS.images, JSON.stringify(images));
  localStorage.setItem(KEYS.entries, JSON.stringify(entries));
  localStorage.setItem(KEYS.rules, JSON.stringify(rules));
  localStorage.setItem(KEYS.babyRules, JSON.stringify(babyRules));
}
function ensureDay(k){ if(!entries[k]) entries[k]={diaperState:0, checks:{}, diapersUsed:1}; }

function fmt(d){ return d.toISOString().slice(0,10); }
function firstWeekday(y,m){ return (new Date(y,m,1).getDay()+6)%7; }
function daysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }
function startOfWeek(d){ const x=new Date(d); x.setHours(0,0,0,0); const k=(x.getDay()+6)%7; x.setDate(x.getDate()-k); return x; }

function dayPoints(key){
  ensureDay(key);
  const st=entries[key].diaperState;
  const diaperPts=(st>=1?rules.wet:0)+(st===2?rules.sale:0);
  const checksPts=Object.entries(entries[key].checks).reduce((s,[id,v])=>v?s+(tasks.find(t=>t.id===id)?.points||0):s,0);
  return diaperPts+checksPts;
}

document.body.innerHTML = `
<h1>Diaper tracker V5</h1>
<div class="subtitle">suivie pour apprendre à devenir un vrai bébé</div>
<main class="container">
  <aside class="panel">
    <h3>Compteurs</h3>
    <div class="progress">
      <div class="progress-row"><div>Semaine</div><div class="bar"><div id="weeklyBar"></div></div><div><b id="weeklyPts">0</b> pts</div></div>
      <div class="progress-row"><div>Mois</div><div class="bar"><div id="monthlyBar"></div></div><div><b id="monthlyPts">0</b> pts</div></div>
    </div>
    <div class="stat-line"><span class="small">Couches utilisées (mois)</span><span class="badge" id="monthDiapers">0</span></div>
    <hr/>
    <h3>Règles points couche</h3>
    <div class="flex">
      <label>Pipi <input id="wetPts" type="number" value="${rules.wet}" style="width:80px"></label>
      <label>Sale <input id="salePts" type="number" value="${rules.sale}" style="width:80px"></label>
      <button class="btn" id="saveRules">OK</button>
    </div>
    <hr/>
    <h3>Actions (cases à cocher)</h3>
    <div id="taskList" class="grid"></div>
    <form id="addTaskForm" class="grid" style="margin-top:6px">
      <input id="taskName" placeholder="Nom de l'action" required>
      <input id="taskPoints" type="number" placeholder="Points (+/-)" required>
      <div class="flex">
        <input id="taskSticker" type="file" accept="image/*">
        <button class="btn">Ajouter</button>
      </div>
      <small class="small">Ce bandeau sert à créer de nouvelles actions. Elles apparaîtront ensuite dans le détail de chaque journée.</small>
    </form>

    <div class="legend-panel">
      <div class="it"><img src="${images.state_clean}" alt=""><span>propre</span></div>
      <div class="it"><img src="${images.state_wet}" alt=""><span>pipi</span></div>
      <div class="it"><img src="${images.state_messy}" alt=""><span>pipi + sale</span></div>
    </div>

    <hr/>
    <h3>Règle de bébé</h3>
    <div class="grid">
      <textarea id="ruleInput" class="textarea" placeholder="Écris ici tes règles de bébé (une par ligne)"></textarea>
      <div class="flex">
        <button class="btn" id="addRules">Ajouter</button>
        <button class="btn ghost" id="clearRules">Tout effacer</button>
      </div>
      <div id="rulesList" class="grid"></div>
    </div>
  </aside>

  <section class="calendar-card">
    <div class="cal-head">
      <button class="btn ghost" id="prevMonth">←</button>
      <div class="month-label" id="monthLabel"></div>
      <button class="btn ghost" id="nextMonth">→</button>
    </div>
    <div class="cal-grid" id="calGrid"></div>
  </section>
</main>

<div class="modal" id="dayModal">
  <div class="modal-backdrop" id="mb"></div>
  <div class="modal-body">
    <div class="flex" style="justify-content:space-between">
      <h3 id="mdDate">—</h3>
      <button class="btn ghost" id="closeM">Fermer</button>
    </div>
    <div class="section compact">
      <h4>État de la couche</h4>
      <div class="state-row">
        <!-- Centered state image at ~80% of large -->
        <img id="stateImg" src="" width="230" height="230" style="object-fit:contain">
        <div class="grid small">
          <button class="btn ghost" data-set="0">Propre</button>
          <button class="btn ghost" data-set="1">Pipi</button>
          <button class="btn ghost" data-set="2">Pipi + sale</button>
        </div>
      </div>
    </div>
    <div class="section compact">
      <h4>Actions du jour</h4>
      <div id="checklist" class="checklist"></div>
    </div>
    <div class="section compact">
      <h4>Couches utilisées (statistique)</h4>
      <div class="pills flex">
        <span class="pill" data-n="1">1</span>
        <span class="pill" data-n="2">2</span>
        <span class="pill" data-n="3">3</span>
        <span class="pill" data-n="4">4</span>
      </div>
      <div class="small">N’influe pas les points.</div>
    </div>
    <div class="section compact">
      <div class="stat-line"><span>Points du jour</span><b id="dayPts">0</b></div>
    </div>
  </div>
</div>
`;

const calGrid=document.getElementById('calGrid'); const monthLabel=document.getElementById('monthLabel');
let viewing=new Date(); viewing.setDate(1);

function renderCalendar(){
  calGrid.innerHTML='';
  const days = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
  days.forEach(n=>{const h=document.createElement('div');h.className='day-head';h.textContent=n;calGrid.appendChild(h);});
  const y=viewing.getFullYear(), m=viewing.getMonth(); monthLabel.textContent=new Date(y,m,1).toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
  function firstWeekday(y,m){ return (new Date(y,m,1).getDay()+6)%7; }
  function daysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }
  for(let i=0;i<firstWeekday(y,m);i++){ const b=document.createElement('div'); b.className='day'; b.style.visibility='hidden'; calGrid.appendChild(b); }
  const total=daysInMonth(y,m);
  function fmt(d){ return d.toISOString().slice(0,10); }
  function dayPoints(key){
    if(!entries[key]) entries[key]={diaperState:0, checks:{}, diapersUsed:1};
    const st=entries[key].diaperState;
    const diaperPts=(st>=1?rules.wet:0)+(st===2?rules.sale:0);
    const checksPts=Object.entries(entries[key].checks).reduce((s,[id,v])=>v?s+(tasks.find(t=>t.id===id)?.points||0):s,0);
    return diaperPts+checksPts;
  }
  for(let d=1; d<=total; d++){
    const k=fmt(new Date(y,m,d,12));
    if(!entries[k]) entries[k]={diaperState:0, checks:{}, diapersUsed:1};
    const st=entries[k].diaperState;
    const img = st===2?images.state_messy: st===1?images.state_wet: images.state_clean;
    const cell=document.createElement('div'); cell.className='day';
    cell.innerHTML=`<div class="num">${d}</div><div class="thumb"><img src="images/diaper_clean.webp" alt=""></div><div class="pts">${dayPoints(k)} pts</div>`;
    cell.querySelector('img').src = img;
    cell.onclick=()=>openDay(k);
    calGrid.appendChild(cell);
  }
  const now=new Date();
  const s=(d=>{const x=new Date(d);x.setHours(0,0,0,0);const k=(x.getDay()+6)%7;x.setDate(x.getDate()-k);return x;})(now);
  let w=0; for(let i=0;i<7;i++){ const d=new Date(s); d.setDate(s.getDate()+i); w+=dayPoints(fmt(d)); }
  let mo=0; for(let d=1; d<=total; d++) mo+=dayPoints(fmt(new Date(y,m,d,12)));
  let used=0; for(let d=1; d<=total; d++){ const k=fmt(new Date(y,m,d,12)); if(entries[k]?.diapersUsed) used+=entries[k].diapersUsed; }
  document.getElementById('weeklyPts').textContent=w; document.getElementById('monthlyPts').textContent=mo;
  document.getElementById('weeklyBar').style.width=Math.min(100,Math.round(100*w/100))+'%';
  document.getElementById('monthlyBar').style.width=Math.min(100,Math.round(100*mo/400))+'%';
  document.getElementById('monthDiapers').textContent=used;
}
renderCalendar();

document.getElementById('prevMonth').onclick=()=>{ viewing.setMonth(viewing.getMonth()-1); renderCalendar(); };
document.getElementById('nextMonth').onclick=()=>{ viewing.setMonth(viewing.getMonth()+1); renderCalendar(); };
document.getElementById('saveRules').onclick=()=>{ rules.wet=parseInt(document.getElementById('wetPts').value,10)||0; rules.sale=parseInt(document.getElementById('salePts').value,10)||0; saveAll(); renderCalendar(); };

/* ---------- Actions list in left panel (create/delete) ---------- */
const taskList = document.getElementById('taskList');
function renderTaskList(){
  taskList.innerHTML='';
  tasks.forEach((t,i)=>{
    const row = document.createElement('div');
    row.className='rule';
    row.innerHTML = `<div class="flex"><img src="${t.icon}" style="width:28px;height:28px;object-fit:contain"><b>${t.name}</b><span class="${t.points>=0?'pos':'neg'} small">(${t.points} pts)</span></div><button class="btn ghost" data-del="${i}">Supprimer</button>`;
    row.querySelector('[data-del]').onclick=()=>{ tasks.splice(i,1); saveAll(); renderTaskList(); };
    taskList.appendChild(row);
  });
}
renderTaskList();

document.getElementById('addTaskForm').onsubmit=(e)=>{
  e.preventDefault();
  const name = document.getElementById('taskName').value.trim();
  const pts = parseInt(document.getElementById('taskPoints').value,10);
  const file = document.getElementById('taskSticker').files[0];
  if(!name || isNaN(pts)) return;
  const id = name.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');
  function add(iconUrl){ tasks.push({id,name,points:pts,icon:iconUrl||'images/diaper_clean.webp'}); saveAll(); renderTaskList(); document.getElementById('addTaskForm').reset(); }
  if(file){
    const reader = new FileReader();
    reader.onload = (ev)=> add(ev.target.result); // store as data URL so it persists
    reader.readAsDataURL(file);
  }else{
    add('images/diaper_clean.webp');
  }
};

/* ---------- Baby rules ---------- */
const rulesList = document.getElementById('rulesList');
function renderRules(){
  rulesList.innerHTML='';
  if(!babyRules.length){ rulesList.innerHTML='<div class="small">Aucune règle pour l’instant.</div>'; return;}
  babyRules.forEach((r,i)=>{
    const d=document.createElement('div'); d.className='rule'; d.innerHTML=`<span>${r}</span><button class="btn ghost" data-del="${i}">Supprimer</button>`;
    d.querySelector('[data-del]').onclick=()=>{ babyRules.splice(i,1); saveAll(); renderRules(); };
    rulesList.appendChild(d);
  });
}
document.getElementById('addRules').onclick=()=>{
  const txt=document.getElementById('ruleInput').value.trim();
  if(!txt) return;
  txt.split(/\n+/).map(s=>s.trim()).filter(Boolean).forEach(line=>babyRules.push(line));
  document.getElementById('ruleInput').value='';
  saveAll(); renderRules();
};
document.getElementById('clearRules').onclick=()=>{ babyRules=[]; saveAll(); renderRules(); };
renderRules();

/* ---------- Day modal + checklist ---------- */
const modal=document.getElementById('dayModal'); const mdDate=document.getElementById('mdDate'); const stateImg=document.getElementById('stateImg'); const checklist=document.getElementById('checklist'); const dayPtsEl=document.getElementById('dayPts'); let currentKey=null;
function openDay(k){
  currentKey=k; ensureDay(k);
  mdDate.textContent=new Date(k).toLocaleDateString('fr-FR',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  stateImg.src = entries[k].diaperState===2?images.state_messy: entries[k].diaperState===1?images.state_wet: images.state_clean;
  checklist.innerHTML='';
  tasks.forEach(t=>{
    const checked=!!entries[k].checks[t.id];
    const ptsClass = (t.points>=0) ? 'pos' : 'neg';
    const item = document.createElement('div');
    item.className = 'check-item';
    item.innerHTML = `
      <img src="${t.icon}" alt="">
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" ${checked?'checked':''}>
        <span>${t.name}</span>
        <span class="small ${ptsClass}">(${t.points} pts)</span>
      </label>`;
    const cb = item.querySelector('input');
    cb.onchange = ()=>{ entries[k].checks[t.id]=cb.checked; saveAll(); updateDay(); };
    checklist.appendChild(item);
  });
  document.querySelectorAll('.pills .pill').forEach(p=>{ const n=parseInt(p.dataset.n,10); p.classList.toggle('active', entries[k].diapersUsed===n); p.onclick=()=>{ entries[k].diapersUsed=n; saveAll(); document.querySelectorAll('.pills .pill').forEach(pp=>pp.classList.toggle('active', parseInt(pp.dataset.n,10)===n)); renderCalendar(); }; });
  dayPtsEl.textContent=dayPoints(k);
  modal.classList.add('show');
}
function updateDay(){ if(!currentKey) return; dayPtsEl.textContent=dayPoints(currentKey); renderCalendar(); }
document.getElementById('closeM').onclick=()=>modal.classList.remove('show'); document.getElementById('mb').onclick=()=>modal.classList.remove('show');
document.querySelectorAll('[data-set]').forEach(b=>{ b.onclick=()=>{ entries[currentKey].diaperState=parseInt(b.dataset.set,10); saveAll(); openDay(currentKey); renderCalendar(); }; });
</script>
</body></html>
